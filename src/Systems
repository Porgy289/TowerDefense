import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.util.ArrayList;


public class Systems extends JComponent
{
    private ArrayList<Enemy> EnemyBuffer;
    private ArrayList<Enemy> Enemies;
    private ArrayList<Projectile> Projectiles;
    private ArrayList<Projectile> ProjectileBuffer;
    private ArrayList<Towers> Tower;
    private ArrayList<Towers> TowerBuffer;

    private int currentTowerPrice;
    private Tower currentTower;

    private static boolean runningLevel;
    private LevelChanger levelChanger;

    private Terrain map;

    int money;

    private int lives;

    int mouseX;
    int mouseY;

    public System()
    {
        EnemyBuffer = new ArrayList<>();
        Enemies = new ArrayList<>();
        TowerBuffer = new ArrayList<>();
        Tower = new ArrayList<>();
        ProjectileBuffer = new ArrayList<>();
        Projectiles = new ArrayList<>();

        this.setPreferredSize( new Dimension( 400, 400 ) );

        this.map = new TerrainLayout();
        levelChanger = new LevelChanger();

        lives = 100;

        money = 50;

        runningLevel = false;

        this.addMouseListener(new MouseAdapter()
        {
            @Override
            public void mouseClicked(MouseEvent e)
            {
                if( currentTower == null )
                {
                    return;
                }

                int x = e.getX();
                int y = e.getY();
                if( money >= currentTowerPrice && canPlaceCurrentTower() ) {
                    addTower( currentTower );
                    currentTower = null;
                    money -= currentTowerPrice;
                }
            }
        });

        this.addMouseMotionListener(new MouseMotionAdapter()
        {
            @Override
            public void mouseMoved(MouseEvent e)
            {
                if( currentTower != null )
                {
                    currentTower.x = e.getX();
                    currentTower.y = e.getY();
                }
                mouseX = e.getX();
                mouseY = e.getY();
            }
        });

        this.addKeyListener(new KeyAdapter()
        {
            @Override
            public void keyPressed(KeyEvent e)
            {
                if( e.getKeyCode() == KeyEvent.VK_SPACE )
                {
                    runningLevel = true;
                    return;
                }
                if( e.getKeyCode() == KeyEvent.VK_P )
                {
                    if( money < 50 )
                    {
                        return;
                    }
                    currentTower = new PeaShooter(mouseX,mouseY);
                    currentTowerPrice = 50;
                    return;
                }
                if( e.getKeyCode() == KeyEvent.VK_S )
                {
                    if( money < 75 )
                    {
                        return;
                    }
                    currentTower = new SpreadShot(mouseX,mouseY);
                    currentTowerPrice = 75;
                    return;
                }
                currentTower = null;
            }
        });
    }

    public void addEnemy( Enemy b )
    {
        EnemyBuffer.add( b );
    }
    public void addTower( Towers t )
    {
        TowerBuffer.add( t );
    }
    public void addProjectile( Projectile b )
    {
        ProjectileBuffer.add( b );
    }

    private boolean canPlaceCurrentTower()
    {
        for( Towers t : TowerBuffer )
        {
            if( t.intersects( currentTower ) )
            {
                return false;
            }
        }
        for( Towers t : Tower )
        {
            if( t.intersects( currentTower ) )
            {
                return false;
            }
        }
        return map.canPlace( currentTower );
    }


    public void tick()
    {
        // Release new Enemies the level
        Enemy released = null;
        if( !levelChanger.currentLevelIsDone() )
        {
            released = levelChanger.tickCurrentLevel() ;
        }
        if( released != null )
        {
            map.place( released );
            enemies.add( released );
        }

        // Tick all of the towers
        for( Towers t : Tower )
        {
            t.tick( map, Enemies, Projectiles );
        }

        // Move each Enemy
        for( Enemy b : Enemies )
        {
            map.move( b );
        }

        // Tick each projectile
        for( int i = 0; i < Projectiles.size(); ++i )
        {
            Projectile b = Projectiles.get( i );
            if( b.getX() < 0 || b.getX() > 400 ||
                    b.getY() < 0 || b.getY() > 400 )
            {
                Projectiles.remove( i-- );
            }
            else
            {
                b.tick();
            }
        }
        for( Projectile b : Projectiles )
        {
            b.tick();
        }

        for( int i = 0; i < Projectiles.size(); ++i )
        {
            for( int j = 0; j < Enemies.size(); ++j )
            {
                if( Projectiles.get(i).intersects(Enemies.get(j)))
                {
                    Projectiles.remove(i--);
                    if(Enemies.get(j).getHit())
                    {
                        Enemies.remove(j--);
                        money += 5;
                    }
                    break;
                }
            }
        }

        // Check for Enemies that made it past
        for( int i = 0; i < Enemies.size(); ++i )
        {
            if( map.isPast( Enemies.get(i) ) )
            {
                lives -= Enemies.get(i).rank;
                Enemies.remove( i-- );
            }
        }

        if( lives <= 0 )
        {
            lives = 0;
            System.out.println("You Lost :(");
            System.exit(2);
        }

        // Check for beating the level
        if( Enemies.size() == 0 && levelChanger.currentLevelIsDone() )
        {
            boolean beaten = levelChanger.nextLevel();
            runningLevel = false;
            Projectiles.clear();
            if( beaten )
            {
                System.out.println( "You Win!" );
                System.exit(1);
            }
        }
    }

    public void paintSystem( Graphics gi )
    {
        // Synchronously move spawned bodies into the actual lists
        for( Enemy b : EnemyBuffer )
        {
            Enemies.add( b );
        }
        EnemyBuffer.clear();

        for( Towers t : TowerBuffer )
        {
            Tower.add( t );
        }
        TowerBuffer.clear();

        for( Projectile b : ProjectileBuffer )
        {
            Projectiles.add( b );
        }
        ProjectileBuffer.clear();

        if(runningLevel)
        {
            // Tick the world
            tick();
        }

        // Draw everything in the world
        Graphics2D g = (Graphics2D)gi;
        map.draw( g );
        for( Enemy b : Enemies )
        {
            b.draw( g );
        }
        for( Towers t : Tower )
        {
            t.draw( g );
        }
        for( Projectile b : Projectiles )
        {
            b.draw( g );
        }

        if( currentTower != null )
        {
            if( canPlaceCurrentTower() )
            {
                g.setColor( new Color( 0, 0, 0, 50 ) );
            }
            else
            {
                g.setColor( new Color( 255, 0, 0, 120 ) );
            }
            g.fillOval( currentTower.getX() - currentTower.getRange(),
                    currentTower.getY() - currentTower.getRange(),
                    currentTower.getRange() * 2,
                    currentTower.getRange() * 2);
            currentTower.draw( g );
        }

        g.setColor( Color.BLACK );

        if( currentTower == null )
        {
            g.drawString("[P]: $50 Pea Shooter", 10, 30 );
            g.drawString("[S]: $75 Spread Shot", 10, 50 );
        }

        g.drawString( "Lives: " + lives, 10, 395 );
        g.drawString( "Level: " + levelChanger.getLevelNumber(), 150, 395 );
        g.drawString( "Money: $" + money, 290, 395 );
        if( !runningLevel)
        {
            g.drawString( "Press [Space] to Start Next Level", 10, 370 );
        }
    }
}

